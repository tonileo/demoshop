import{a as me}from"./chunk-3JOVGMPH.js";import{b as de}from"./chunk-N65AT7QA.js";import{a as ee}from"./chunk-OGOVZLXA.js";import{A as te,E as re,F as ne,G as ie,H as oe,I as ae,P as se,S as le,W as ce}from"./chunk-HISGLHQX.js";import{b as P,ja as $,k as z,n as S}from"./chunk-7XK2MI2N.js";import{Db as W,Gc as F,Ib as a,Jb as s,Ob as L,Pc as Q,Rb as T,Sc as Y,Tb as G,Vc as Z,ba as R,db as p,dc as l,e as c,ea as C,ec as _,fc as k,hc as H,ic as X,jc as K,ka as d,lc as J,oa as B,pc as v,qb as V,qc as y,w as u,wb as A,x as w,xa as E,ya as I,yb as x}from"./chunk-KSTUA5KL.js";var pe="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var ue=(i=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(i));for(;i--;)e+=pe[t[i]&63];return e};var O=class{id=ue();items=[];coupon;deliveryMethodId;paymentIntentId;clientSecret};var f=class i{baseUrl=S.apiUrl;http=d(P);cart=V(null);itemCount=F(()=>this.cart()?.items.reduce((e,t)=>e+t.quantity,0));selectedDelivery=V(null);totals=F(()=>{let e=this.cart(),t=this.selectedDelivery();if(!e)return null;let r=0,n=e.items.reduce((m,h)=>m+h.price*h.quantity,0),o=t?t.price:0;return e.coupon&&(e.coupon.amountOff?r=e.coupon.amountOff:e.coupon.percentOff&&(r=n*(e.coupon.percentOff/100))),{subtotal:n,shipping:o,discount:r,total:n+o-r}});getCart(e){return this.http.get(this.baseUrl+"cart?id="+e).pipe(w(t=>(this.cart.set(t),t)))}setCart(e){return this.http.post(this.baseUrl+"cart",e).pipe(R(t=>{this.cart.set(t)}))}addItemtoCart(e,t=1){return c(this,null,function*(){let r=this.cart()??this.createCart();this.isProduct(e)&&(e=this.mapProductToCartItem(e)),r.items=this.addOrUpdateItem(r.items,e,t),yield u(this.setCart(r))})}removeItemFromCart(e,t=1){return c(this,null,function*(){let r=this.cart();if(!r)return;let n=r.items.findIndex(o=>o.productId===e);n!==-1&&(r.items[n].quantity>t?r.items[n].quantity-=t:r.items.splice(n,1),r.items.length===0?this.deleteCart():yield u(this.setCart(r)))})}deleteCart(){this.http.delete(this.baseUrl+"cart?id="+this.cart()?.id).subscribe({next:()=>{localStorage.removeItem("cart_id"),this.cart.set(null)}})}addOrUpdateItem(e,t,r){let n=e.findIndex(o=>o.productId===t.productId);return n===-1?(t.quantity=r,e.push(t)):e[n].quantity+=r,e}mapProductToCartItem(e){return{productId:e.id,productName:e.name,price:e.price,quantity:0,pictureUrl:e.pictureUrl,brand:e.brand,type:e.type}}isProduct(e){return e.id!==void 0}createCart(){let e=new O;return localStorage.setItem("cart_id",e.id),e}applyDiscount(e){return this.http.get(this.baseUrl+"coupons/"+e)}static \u0275fac=function(t){return new(t||i)};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};var ye="https://js.stripe.com/v3",Ce=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,he="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Ee=function(){for(var e=document.querySelectorAll('script[src^="'.concat(ye,'"]')),t=0;t<e.length;t++){var r=e[t];if(Ce.test(r.src))return r}return null},ve=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(ye).concat(t);var n=document.head||document.body;if(!n)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return n.appendChild(r),r},Ie=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"4.3.0",startTime:t})},b=null,U=null,j=null,xe=function(e){return function(){e(new Error("Failed to load Stripe.js"))}},_e=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},Pe=function(e){return b!==null?b:(b=new Promise(function(t,r){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe&&e&&console.warn(he),window.Stripe){t(window.Stripe);return}try{var n=Ee();if(n&&e)console.warn(he);else if(!n)n=ve(e);else if(n&&j!==null&&U!==null){var o;n.removeEventListener("load",j),n.removeEventListener("error",U),(o=n.parentNode)===null||o===void 0||o.removeChild(n),n=ve(e)}j=_e(t,r),U=xe(r),n.addEventListener("load",j),n.addEventListener("error",U)}catch(m){r(m);return}}),b.catch(function(t){return b=null,Promise.reject(t)}))},Oe=function(e,t,r){if(e===null)return null;var n=e.apply(void 0,t);return Ie(n,r),n},g,Se=!1,be=function(){return g||(g=Pe(null).catch(function(e){return g=null,Promise.reject(e)}),g)};Promise.resolve().then(function(){return be()}).catch(function(i){Se||console.warn(i)});var ge=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];Se=!0;var n=Date.now();return be().then(function(o){return Oe(o,t,n)})};var M=class i{baseUrl=S.apiUrl;cartService=d(f);http=d(P);accountService=d(de);stripePromise;elements;addressElement;paymentElement;constructor(){this.stripePromise=ge(S.stripePublicKey)}getStripeInstance(){return this.stripePromise}initialiteElements(){return c(this,null,function*(){if(!this.elements){let e=yield this.getStripeInstance();if(e){let t=yield u(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"}})}else throw new Error("Stripe has not been loaded")}return this.elements})}createPaymentElement(){return c(this,null,function*(){if(!this.paymentElement){let e=yield this.initialiteElements();if(e)this.paymentElement=e.create("payment");else throw new Error("Elements instace has  not been initialized")}return this.paymentElement})}createAddressElement(){return c(this,null,function*(){if(!this.addressElement){let e=yield this.initialiteElements();if(e){let t=this.accountService.currentUser(),r={};t&&(r.name=t.firstName+" "+t.lastName),t?.address&&(r.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,country:t.address.country,postal_code:t.address.postalCode});let n={mode:"shipping",defaultValues:r};this.addressElement=e.create("address",n)}else throw new Error("Elements instance has not been loaded")}return this.addressElement})}createConfirmationToken(){return c(this,null,function*(){let e=yield this.getStripeInstance(),t=yield this.initialiteElements(),r=yield t.submit();if(r.error)throw new Error(r.error.message);if(e)return yield e.createConfirmationToken({elements:t});throw new Error("Stripe not availiable")})}confirmPayment(e){return c(this,null,function*(){let t=yield this.getStripeInstance(),n=yield(yield this.initialiteElements()).submit();if(n.error)throw new Error(n.error.message);let o=this.cartService.cart()?.clientSecret;if(t&&o)return yield t.confirmPayment({clientSecret:o,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Unable to load stripe")})}createOrUpdatePaymentIntent(){let e=this.cartService.cart(),t=!!e?.clientSecret;if(!e)throw new Error("Problem with cart");return this.http.post(this.baseUrl+"payment/"+e.id,{}).pipe(w(r=>(t||this.cartService.setCart(r),r)))}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}static \u0275fac=function(t){return new(t||i)};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};function Ue(i,e){i&1&&(a(0,"div",11)(1,"button",19),l(2,"Checkout"),s(),a(3,"button",20),l(4,"Continue shopping"),s()())}function je(i,e){if(i&1){let t=L();a(0,"div",21)(1,"span"),l(2),s(),a(3,"button",22),T("click",function(){E(t);let n=G();return I(n.removeCoupon())}),a(4,"mat-icon",23),l(5,"delete"),s()()()}if(i&2){let t=e.ngIf;p(2),k("",t.name," applied")}}var we=class i{cartService=d(f);location=d(Q);stripeService=d(M);code;applyCoupon(){this.code&&this.cartService.applyDiscount(this.code).subscribe({next:e=>c(this,null,function*(){let t=this.cartService.cart();t&&(t.coupon=e,yield u(this.cartService.setCart(t)),this.code=void 0),this.location.path()==="/checkout"&&(yield u(this.stripeService.createOrUpdatePaymentIntent()))})})}removeCoupon(){return c(this,null,function*(){var e=this.cartService.cart();if(e)e.coupon=void 0,this.cartService.setCart(e);else if(!e)return;this.location.path()==="/checkout"&&(yield u(this.stripeService.createOrUpdatePaymentIntent()))})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=B({type:i,selectors:[["app-order-summary"]],standalone:!0,features:[J],decls:43,vars:17,consts:[["form","ngForm"],[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","border-gray-200","p-4","bg-white","shadow-sm"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium","text-gray-500"],[1,"font-medium","text-gray-900"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-t","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white"],[1,"space-y-2","flex","flex-col","p-2",3,"ngSubmit"],[1,"mb-2","block","text-sm","font-medium"],["class","mb-2 font-semibold flex justify-between",4,"ngIf"],["appearance","outline"],["type","text","name","code","matInput","",3,"ngModelChange","ngModel","disabled"],["type","submit","mat-flat-button","",3,"disabled"],["routerLink","/checkout","mat-flat-button",""],["routerLink","/shop","mat-button",""],[1,"mb-2","font-semibold","flex","justify-between"],["mat-icon-button","",3,"click"],["color","warn"]],template:function(t,r){if(t&1){let n=L();a(0,"div",1)(1,"div",2)(2,"p",3),l(3,"Order summary"),s(),a(4,"div",4)(5,"div",5)(6,"dl",6)(7,"dt",7),l(8,"Subtotal"),s(),a(9,"dd",8),l(10),v(11,"currency"),s()(),a(12,"dl",6)(13,"dt",7),l(14,"Discount"),s(),a(15,"dd",9),l(16),v(17,"currency"),s()(),a(18,"dl",6)(19,"dt",7),l(20,"Delivery fee"),s(),a(21,"dd",8),l(22),v(23,"currency"),s()()(),a(24,"dl",10)(25,"dt",7),l(26,"Total"),s(),a(27,"dd",8),l(28),v(29,"currency"),s()()(),A(30,Ue,5,0,"div",11),s(),a(31,"div",12)(32,"form",13,0),T("ngSubmit",function(){return E(n),I(r.applyCoupon())}),a(34,"label",14),l(35," Do you have a vouncher code? "),s(),A(36,je,6,1,"div",15),a(37,"mat-form-field",16)(38,"mat-label"),l(39,"Voucher code"),s(),a(40,"input",17),K("ngModelChange",function(m){return E(n),X(r.code,m)||(r.code=m),I(m)}),s()(),a(41,"button",18),l(42,"Apply code"),s()()()()}if(t&2){let n,o,m,h,D,N,q;p(10),_(y(11,9,(n=r.cartService.totals())==null?null:n.subtotal)),p(6),k("-",y(17,11,(o=r.cartService.totals())==null?null:o.discount),""),p(6),_(y(23,13,(m=r.cartService.totals())==null?null:m.shipping)),p(6),_(y(29,15,(h=r.cartService.totals())==null?null:h.total)),p(2),W(r.location.path()!=="/checkout"?30:-1),p(6),x("ngIf",(D=r.cartService.cart())==null?null:D.coupon),p(4),H("ngModel",r.code),x("disabled",!!((N=r.cartService.cart())!=null&&N.coupon)),p(),x("disabled",!!((q=r.cartService.cart())!=null&&q.coupon))}},dependencies:[$,z,ce,le,me,Z,se,ae,te,re,ne,oe,ie,ee,Y]})};export{f as a,M as b,we as c};
